{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/information-technology/get-business-day-by-sql","result":{"data":{"blogImage":{"edges":[]},"oldBlogImage":{"edges":[{"node":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEBf/EABYBAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAAB1Yrk3DQD/8QAGBABAAMBAAAAAAAAAAAAAAAAAQIDEAD/2gAIAQEAAQUCepslJwM//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFhAAAwAAAAAAAAAAAAAAAAAAACAi/9oACAEBAAY/Ail//8QAGRABAAMBAQAAAAAAAAAAAAAAAQARIRBR/9oACAEBAAE/IU0xLTA8lEqAOc//2gAMAwEAAgADAAAAEHcf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGxABAQEAAgMAAAAAAAAAAAAAAREAITFBYaH/2gAIAQEAAT8Q4F2DMXxL0it9+dTkdCclz+PrgJv/2Q=="},"images":{"fallback":{"src":"/static/5c0ba2d8171bfb871211569e728ec4c7/29622/cropped-sql.jpg","srcSet":"/static/5c0ba2d8171bfb871211569e728ec4c7/601e8/cropped-sql.jpg 116w,\n/static/5c0ba2d8171bfb871211569e728ec4c7/0cd6d/cropped-sql.jpg 231w,\n/static/5c0ba2d8171bfb871211569e728ec4c7/29622/cropped-sql.jpg 462w","sizes":"(min-width: 462px) 462px, 100vw"},"sources":[{"srcSet":"/static/5c0ba2d8171bfb871211569e728ec4c7/350d1/cropped-sql.avif 116w,\n/static/5c0ba2d8171bfb871211569e728ec4c7/1b465/cropped-sql.avif 231w,\n/static/5c0ba2d8171bfb871211569e728ec4c7/90832/cropped-sql.avif 462w","type":"image/avif","sizes":"(min-width: 462px) 462px, 100vw"},{"srcSet":"/static/5c0ba2d8171bfb871211569e728ec4c7/7db29/cropped-sql.webp 116w,\n/static/5c0ba2d8171bfb871211569e728ec4c7/1de70/cropped-sql.webp 231w,\n/static/5c0ba2d8171bfb871211569e728ec4c7/89631/cropped-sql.webp 462w","type":"image/webp","sizes":"(min-width: 462px) 462px, 100vw"}]},"width":462,"height":260}}}}]},"markdownRemark":{"id":"07306b76-c604-5332-9493-a96c1c86dd1b","excerpt":"…","html":"<p>業務を行う上では、休日を除いた日付を取得したいことがあるかと思います。<br>\nこれが地味に難しいですが、そこそこキレイに取得できたので紹介します。</p>\n<p>当然ですが、祝日を除いた営業日を取得したい場合は、「祝日マスタ」のようなテーブルで情報を保持している必要があります。</p>\n<h3>前提</h3>\n<p>ここでの祝日マスタは以下の形式とします。</p>\n<table>\n<thead>\n<tr>\n<th>ID</th>\n<th>HOLIDAY</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>2019-01-14</td>\n</tr>\n<tr>\n<td>2</td>\n<td>2019-02-11</td>\n</tr>\n<tr>\n<td>3</td>\n<td>2019-03-21</td>\n</tr>\n<tr>\n<td>4</td>\n<td>2019-04-29</td>\n</tr>\n<tr>\n<td>5</td>\n<td>2019-04-30</td>\n</tr>\n<tr>\n<td>6</td>\n<td>2019-05-01</td>\n</tr>\n<tr>\n<td>7</td>\n<td>2019-05-02</td>\n</tr>\n<tr>\n<td>8</td>\n<td>2019-05-03</td>\n</tr>\n<tr>\n<td>9</td>\n<td>2019-05-06</td>\n</tr>\n</tbody>\n</table>\n<h2>実装SQL</h2>\n<p>日付取得に関する要件は色々とあるかと思いますが、ここでは「前営業日を取得する」ことを提示します。翌営業日などほかの要件もこれの応用で取得できると思います。</p>\n<p>ちなみにこれらSQLでの肝は日付候補を複数レコードとして取得することで、Postgressでは generate_series関数というのがとても便利で、Oracleでは同じようなことをlevel疑似列で行います。</p>\n<h3>Postgress版</h3>\n<p>使い方としては、WITH句で前営業日を取得するようにしているので、以降はその一時テーブルから簡単なSELECT文で取得できます。</p>\n<script src=\"https://gist.github.com/nisioka/476c1ef6ec6bc5d8cd9feb8fd02b3c53.js\"></script>\n<p>コメントにも記載していますが、解説もします。まず元となるレコード群とするためにgenerate_series関数で候補数分取得します(ここでは15レコード分)。それらを本日日付(current_date)から引くことで前日から16日前までの候補日付となります。</p>\n<p>そこから絞り混みを行い、(曜日を取得する関数)で土日を除き、祝日マスタに該当しないことをもって祝日を除きます。そうして残ったものが営業日のみの日付候補となるので、max関数を用いて前営業日を取得しています。</p>\n<p>これらから少し修正すれば、翌営業日だったり、土日以外が休みなどにも変更できます。</p>\n<h3>Oracle版</h3>\n<p>Oracle版も基本は同じです。generate_seriesがlevel疑似列に変わっています。</p>\n<script src=\"https://gist.github.com/nisioka/ff5b29b2b555df3b482a002347a55bf5.js\"></script>\n<h2>終わりに</h2>\n<p>そもそも理想を言えば、必要な年月分(10年分とか)のカレンダーを保持して、その日付が休みかどうかのフラグを持っているのが楽です。それを今回はWITH句の中で一時的に作り出しています。</p>\n<p>これから機能設計する場合はそうしたカレンダーベースの営業日の保持の仕方をすることをお勧めします。</p>","fields":{"slug":"/posts/get-business-day-by-sql/"},"frontmatter":{"title":"平日や営業日を取得するSQL(Postgress/Oracle)","date":"2019/08/27","dateModified":null,"description":null,"category":null,"categories":["information-technology"],"tags":["oracle","postgress","sql"]}},"mdPrevious":{"fields":{"slug":"/posts/excel-tips/"},"frontmatter":{"title":"Excelで行の追加/削除しても崩れない「連番」の式","category":null,"categories":["business-efficiency"]}},"mdNext":{"fields":{"slug":"/posts/glossary/"},"frontmatter":{"title":"用語集","category":null,"categories":["glossary"]}}},"pageContext":{"id":"07306b76-c604-5332-9493-a96c1c86dd1b","previousPostId":"e89058e9-6aa5-576d-a51c-e32d65af463c","nextPostId":"83471a7e-eaae-558e-9ced-86368bec2d6b","imagePath":"posts/get-business-day-by-sql/images/cropped-sql.jpg"}},"staticQueryHashes":["3695098706","798193786"],"slicesMap":{}}