{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/information-technology/get-business-day-by-sql","result":{"data":{"allFile":{"edges":[]},"markdownRemark":null,"mdPrevious":null,"mdNext":null,"wpPost":{"id":"cG9zdDoyMjMz","title":"平日や営業日を取得するSQL(Postgress/Oracle)","content":"\n<p>業務を行う上では、休日を除いた日付を取得したいことがあるかと思います。<br> これが地味に難しいですが、そこそこキレイに取得できたので紹介します。 </p>\n\n\n\n<p>当然ですが、祝日を除いた営業日を取得したい場合は、「祝日マスタ」のようなテーブルで情報を保持している必要があります。</p>\n\n\n\n<h3 class=\"wp-block-heading\">前提</h3>\n\n\n\n<p>ここでの祝日マスタは以下の形式とします。</p>\n\n\n\n<table class=\"wp-block-table aligncenter is-style-stripes\"><tbody><tr><td>ID</td><td>HOLIDAY</td></tr><tr><td>1</td><td>2019-01-14</td></tr><tr><td>2</td><td>2019-02-11</td></tr><tr><td>3</td><td>2019-03-21</td></tr><tr><td>4</td><td>2019-04-29</td></tr><tr><td>5</td><td>2019-04-30</td></tr><tr><td>6</td><td>2019-05-01</td></tr><tr><td>7</td><td>2019-05-02</td></tr><tr><td>8</td><td>2019-05-03</td></tr><tr><td>9</td><td>2019-05-06</td></tr></tbody></table>\n\n\n\n<h2 class=\"wp-block-heading\">実装SQL</h2>\n\n\n\n<p>日付取得に関する要件は色々とあるかと思いますが、ここでは「前営業日を取得する」ことを提示します。翌営業日などほかの要件もこれの応用で取得できると思います。</p>\n\n\n\n<p>ちなみにこれらSQLでの肝は日付候補を複数レコードとして取得することで、Postgressでは generate_series関数というのがとても便利で、Oracleでは同じようなことをlevel疑似列で行います。</p>\n\n\n\n<h3 class=\"wp-block-heading\">Postgress版</h3>\n\n\n\n<p>使い方としては、WITH句で前営業日を取得するようにしているので、以降はその一時テーブルから簡単なSELECT文で取得できます。</p>\n\n\n\n<script src=\"https://gist.github.com/nisioka/476c1ef6ec6bc5d8cd9feb8fd02b3c53.js\"></script>\n\n\n\n<p>コメントにも記載していますが、解説もします。まず元となるレコード群とするためにgenerate_series関数で候補数分取得します(ここでは15レコード分)。それらを本日日付(current_date)から引くことで前日から16日前までの候補日付となります。</p>\n\n\n\n<p>そこから絞り混みを行い、(曜日を取得する関数)で土日を除き、祝日マスタに該当しないことをもって祝日を除きます。そうして残ったものが営業日のみの日付候補となるので、max関数を用いて前営業日を取得しています。</p>\n\n\n\n<p>これらから少し修正すれば、翌営業日だったり、土日以外が休みなどにも変更できます。</p>\n\n\n\n<h3 class=\"wp-block-heading\">Oracle版</h3>\n\n\n\n<p>Oracle版も基本は同じです。generate_seriesがlevel疑似列に変わっています。</p>\n\n\n\n<script src=\"https://gist.github.com/nisioka/ff5b29b2b555df3b482a002347a55bf5.js\"></script>\n\n\n\n<h2 class=\"wp-block-heading\">終わりに</h2>\n\n\n\n<p>そもそも理想を言えば、必要な年月分(10年分とか)のカレンダーを保持して、その日付が休みかどうかのフラグを持っているのが楽です。それを今回はWITH句の中で一時的に作り出しています。</p>\n\n\n\n<p>これから機能設計する場合はそうしたカレンダーベースの営業日の保持の仕方をすることをお勧めします。</p>\n","excerpt":"<p>業務を行う上では、休日を除いた日付を取得したいことがあるかと思います。 これが地味に難しいですが、そこそこキレイに取得できたので紹介します。 当然ですが、祝日を除いた営業日を取得したい場合は、「祝日マスタ」のようなテーブ [&hellip;]</p>\n","slug":"get-business-day-by-sql","date":"2019/08/27","modified":"2019/08/27","featuredImage":{"node":{"altText":"","gatsbyImage":{"images":{"sources":[{"srcSet":"/_gatsby/image/42c9a8453274db52f67de103c8355bc5/6c67823d7024618102ccaaf34d232774/cropped-sql.avif?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D45%26h%3D25%26fm%3Davif%26q%3D75&cd=2b2a77dc2d3596295f812b98134c0145 45w,/_gatsby/image/42c9a8453274db52f67de103c8355bc5/9d6af0343d51bb4ebdc7ad14c2d71da0/cropped-sql.avif?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D90%26h%3D51%26fm%3Davif%26q%3D75&cd=2b2a77dc2d3596295f812b98134c0145 90w,/_gatsby/image/42c9a8453274db52f67de103c8355bc5/6491cdb02339a86e9d36b45c2721ff09/cropped-sql.avif?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D180%26h%3D101%26fm%3Davif%26q%3D75&cd=2b2a77dc2d3596295f812b98134c0145 180w,/_gatsby/image/42c9a8453274db52f67de103c8355bc5/77887c98d97d9f487693900c7d00521d/cropped-sql.avif?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D360%26h%3D203%26fm%3Davif%26q%3D75&cd=2b2a77dc2d3596295f812b98134c0145 360w","type":"image/avif","sizes":"(min-width: 180px) 180px, 100vw"},{"srcSet":"/_gatsby/image/42c9a8453274db52f67de103c8355bc5/6b917aeef031a246d9d6a5667ca80da2/cropped-sql.webp?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D45%26h%3D25%26fm%3Dwebp%26q%3D75&cd=2b2a77dc2d3596295f812b98134c0145 45w,/_gatsby/image/42c9a8453274db52f67de103c8355bc5/85f72a2257b2545377d39c8240646832/cropped-sql.webp?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D90%26h%3D51%26fm%3Dwebp%26q%3D75&cd=2b2a77dc2d3596295f812b98134c0145 90w,/_gatsby/image/42c9a8453274db52f67de103c8355bc5/0b30c6b59312f962a76ce5f42d6305ed/cropped-sql.webp?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D180%26h%3D101%26fm%3Dwebp%26q%3D75&cd=2b2a77dc2d3596295f812b98134c0145 180w,/_gatsby/image/42c9a8453274db52f67de103c8355bc5/fa4bebb1115fc782a64fe61e37ad36b3/cropped-sql.webp?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D360%26h%3D203%26fm%3Dwebp%26q%3D75&cd=2b2a77dc2d3596295f812b98134c0145 360w","type":"image/webp","sizes":"(min-width: 180px) 180px, 100vw"}],"fallback":{"src":"/_gatsby/image/42c9a8453274db52f67de103c8355bc5/c4c8b27680b43ea0ecf2a323a8d807d9/cropped-sql.jpg?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D45%26h%3D25%26fm%3Djpg%26q%3D75&cd=2b2a77dc2d3596295f812b98134c0145","srcSet":"/_gatsby/image/42c9a8453274db52f67de103c8355bc5/c4c8b27680b43ea0ecf2a323a8d807d9/cropped-sql.jpg?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D45%26h%3D25%26fm%3Djpg%26q%3D75&cd=2b2a77dc2d3596295f812b98134c0145 45w,/_gatsby/image/42c9a8453274db52f67de103c8355bc5/35300bc03417d5cf8220bd62ba43c621/cropped-sql.jpg?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D90%26h%3D51%26fm%3Djpg%26q%3D75&cd=2b2a77dc2d3596295f812b98134c0145 90w,/_gatsby/image/42c9a8453274db52f67de103c8355bc5/50fad863b1a12ed140bb61bf9d737fb1/cropped-sql.jpg?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D180%26h%3D101%26fm%3Djpg%26q%3D75&cd=2b2a77dc2d3596295f812b98134c0145 180w,/_gatsby/image/42c9a8453274db52f67de103c8355bc5/48352748582425339356e99bd30a725f/cropped-sql.jpg?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D360%26h%3D203%26fm%3Djpg%26q%3D75&cd=2b2a77dc2d3596295f812b98134c0145 360w","sizes":"(min-width: 180px) 180px, 100vw"}},"layout":"constrained","width":180,"height":101,"backgroundColor":"rgb(200,216,216)"}}},"categories":{"nodes":[{"name":"技術"}]},"tags":{"nodes":[{"name":"oracle"},{"name":"Postgress"},{"name":"SQL"}]}},"wpPrevious":{"title":"Go Conference 2019 Autumn セッション資料まとめ","slug":"go-conference-2019-autumn","categories":{"nodes":[{"name":"イベントレポート"}]}},"wpNext":{"title":"7payの不正アクセスについてセキュリティスペシャリストが解説","slug":"7pay-unauthorized-access","categories":{"nodes":[{"name":"生活"}]}}},"pageContext":{"id":"cG9zdDoyMjMz","previousPostId":"cG9zdDoyMjYx","nextPostId":"cG9zdDoyMTc1","imagePath":null}},"staticQueryHashes":["2488138200","3280520893"],"slicesMap":{}}