{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/information-technology/spring-boot_vertion-up_2-7to3-1","result":{"data":{"allFile":{"edges":[]},"markdownRemark":null,"mdPrevious":null,"mdNext":null,"wpPost":{"id":"cG9zdDozMDcw","title":"Spring Bootの2.7系から3.1系へのバージョンアップ対応のハマりどころ","content":"\n<p>Spring Bootのバージョンアップに際して、一部ソースコード修正などの対応が必要になる部分が少なからずあります。私がハマったところベースでいくつか対応方法を説明していきたいと思います。</p>\n\n\n\n<p>サポート期間が、2.7.xと3.0.xとでほとんど変わらないため、多くは3.1.xまで一気に上げるかと思われます。メジャーバージョンアップである「2.7.x→3.0.x」が、破壊的変更もあって、対応としてはかなり大変ですが、マイナーバージョンアップである「3.0.x→3.1.x」のほうは影響がないことがほとんどだと思います。</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img src=\"/_gatsby/file/786acd3a58da0bb52df7f251c4d47982/image.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2023%2F08%2Fimage.png\" alt=\"\" class=\"wp-image-3071 inline-gatsby-image-wrapper\"/></figure>\n\n\n\n<p>大まかな流れは下記の公式の移行ガイド(英語)を読みながら進めていくのが良いかと思います。</p>\n\n\n\n<p><a href=\"https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide\">https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide</a></p>\n\n\n\n<h2 class=\"wp-block-heading\">Spring Security 6系への対応</h2>\n\n\n\n<p>SecurityConfigurationの実装の仕方を変える必要があります。WebSecurityConfigurerAdapterを継承して構築していたかと思われますが、これが非推奨となり、SecurityFilterChainを@Beanで定義する実装に修正する必要があります。3.0.x</p>\n\n\n\n<h3 class=\"wp-block-heading\">【2.7.xまでのコード例】</h3>\n\n\n\n<pre class=\"wp-block-code\"><code>import org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n\n@Configuration\npublic class SecurityConfiguration extends WebSecurityConfigurerAdapter {\n  @Autowired\n  public void configure(AuthenticationManagerBuilder auth) throws Exception {\n    auth.inMemoryAuthentication();\n  }\n\n  @Override\n  protected void configure(HttpSecurity http) throws Exception {\n    http.authorizeRequests()\n        .antMatchers(\"/health/**\")\n        .permitAll()\n        .anyRequest()\n        .authenticated();\n    http.csrf().disable();\n  }\n}</code></pre>\n\n\n\n<h3 class=\"wp-block-heading\">【3.0.xでのコード修正例】</h3>\n\n\n\n<pre class=\"wp-block-code\"><code>import org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.provisioning.InMemoryUserDetailsManager;\nimport org.springframework.security.web.SecurityFilterChain;\n\n@Configuration\npublic class SecurityConfiguration {\n  @Bean\n  public InMemoryUserDetailsManager userDetailsService() {\n    return new InMemoryUserDetailsManager();\n  }\n\n  @Bean\n  public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n    http.authorizeHttpRequests()\n        .requestMatchers(\"/health/**\")\n        .permitAll()\n        .anyRequest()\n        .authenticated();\n    http.csrf().disable();\n    return http.build();\n  }\n}</code></pre>\n\n\n\n<h3 class=\"wp-block-heading\">修正ポイント</h3>\n\n\n\n<ul>\n<li>WebSecurityConfigurerAdapter の継承を辞める。</li>\n\n\n\n<li>configure(HttpSecurity)のOverrideではなく、public SecurityFilterChain securityFilterChain(HttpSecurity)を@Bean定義する。\n<ul>\n<li>その中で、HttpSecurity.authorizeRequests()ではなく、HttpSecurity.authorize<strong>Http</strong>Requests()を使うように変更。（非常に視認性が悪いですが、authorize<strong>Http</strong>Requestsという異なる名称のものがあります。）</li>\n</ul>\n</li>\n\n\n\n<li>LDAP認証、JDBC認証、インメモリ認証を使う場合はそれぞれ対応が必要。何れも下記のページを参照して対応するのがわかりやすい。</li>\n</ul>\n\n\n\n<p><a href=\"https://spring.io/blog/2022/02/21/spring-security-without-the-websecurityconfigureradapter\">https://spring.io/blog/2022/02/21/spring-security-without-the-websecurityconfigureradapter</a></p>\n\n\n\n<h2 class=\"wp-block-heading\">javax → jakarta置換</h2>\n\n\n\n<p>商標権の都合で、java EE系のパッケージが、jakarta EEというパッケージに変わっています。基本的に中身が変わる類のものではないので、ソースコードの置換をしていく対応となります。</p>\n\n\n\n<p>ただし、引き続きjavaxパッケージとして使われるものも多いので、javaxをjakartaに全て一括置換はNGです。コンパイル時にClassNotFoundが発生すると思うので、それらを何度か適宜置換していく対応していってください。「javax.annotation → jakarta.annotation」の置換でそれなりに充足すると思います。</p>\n\n\n\n<h2 class=\"wp-block-heading\">httpClientが 4.x -&gt; 5.x に変更</h2>\n\n\n\n<p>SpringBootの内部依存しているhttpClientのメジャーバージョンが変わっており、その変更に対応する必要があります。RestTemplateで使っている人も多い部分かと思います。それなりにガッツリ変わっているので、頑張って移行ガイドを読んでいく必要があります。</p>\n\n\n\n<h3 class=\"wp-block-heading\">【2.7.xまでのコード例】</h3>\n\n\n\n<pre class=\"wp-block-code\"><code>  @Bean\n  public RestTemplate restTemplate() throws NoSuchAlgorithmException {\n    HttpClientBuilder httpClientBuilder = HttpClientBuilder.create();\n    httpClientBuilder.setSSLContext(SSLContext.getDefault());\n\n    HttpComponentsClientHttpRequestFactory requestFactory =\n        new HttpComponentsClientHttpRequestFactory();\n    requestFactory.setHttpClient(httpClientBuilder.build());\n    requestFactory.setConnectTimeout(5000);\n    requestFactory.setReadTimeout(5000);\n\n    return new RestTemplate(requestFactory);\n  }</code></pre>\n\n\n\n<h3 class=\"wp-block-heading\">【3.0.xでのコード修正例】</h3>\n\n\n\n<pre class=\"wp-block-code\"><code>  @Bean\n  public RestTemplate restTemplate() throws NoSuchAlgorithmException {\n\n    try (PoolingHttpClientConnectionManager connectionManager = PoolingHttpClientConnectionManagerBuilder.create()\n        .setSSLSocketFactory(SSLConnectionSocketFactoryBuilder.create()\n            .setSslContext(SSLContext.getDefault())\n            .setTlsVersions(TLS.V_1_3)\n            .build())\n        .setDefaultSocketConfig(SocketConfig.custom()\n            .setSoTimeout(Timeout.ofSeconds(5L))\n            .build())\n        .setPoolConcurrencyPolicy(PoolConcurrencyPolicy.STRICT)\n        .setDefaultConnectionConfig(ConnectionConfig.custom()\n            .setConnectTimeout(Timeout.ofSeconds(5L))\n            .build())\n        .build()) {\n      HttpClientBuilder httpClientBuilder = HttpClientBuilder.create();\n      httpClientBuilder.setConnectionManager(connectionManager);\n      HttpComponentsClientHttpRequestFactory requestFactory =\n          new HttpComponentsClientHttpRequestFactory();\n      requestFactory.setHttpClient(httpClientBuilder.build());\n\n      return new RestTemplate(requestFactory);\n    }\n  }</code></pre>\n\n\n\n<h3 class=\"wp-block-heading\">修正ポイント</h3>\n\n\n\n<p>ポイントと言えるほど要点があるわけではなく、、下記リンク先の移行ガイド(英語)を参考にがっつり書き換えていく必要があります。ReadTimeoutというのが非推奨となって、SoTimeoutに変えるなど、かなりしっかりと読まないとなりません。</p>\n\n\n\n<p><a href=\"https://hc.apache.org/httpcomponents-client-5.2.x/migration-guide/preparation.html\">https://hc.apache.org/httpcomponents-client-5.2.x/migration-guide/preparation.html</a></p>\n\n\n\n<p><a href=\"https://hc.apache.org/httpcomponents-client-5.2.x/migration-guide/migration-to-classic.html\">https://hc.apache.org/httpcomponents-client-5.2.x/migration-guide/migration-to-classic.html</a></p>\n\n\n\n<h2 class=\"wp-block-heading\">hibernate の5.x → 6.xの対応</h2>\n\n\n\n<p>ORMである、hibernateのメジャーバージョンアップがなされています。hibernateを利用している場合は、これに対応する必要がありますが、破壊的変更が非常に多く、おそらく大多数の方が多大な対応を必要とすると思われます。Type systemという根幹がかなり変わっているため、影響が大きいです。変更内容も広範になるため、別記事にまとめようと思います。</p>\n\n\n\n<p>下記がhibernate公式の移行ガイド(英語)です。</p>\n\n\n\n<p><a href=\"https://docs.jboss.org/hibernate/orm/6.0/migration-guide/migration-guide.html\">https://docs.jboss.org/hibernate/orm/6.0/migration-guide/migration-guide.html</a></p>\n","excerpt":"<p>Spring Bootのバージョンアップに際して、一部ソースコード修正などの対応が必要になる部分が少なからずあります。私がハマったところベースでいくつか対応方法を説明していきたいと思います。 サポート期間が、2.7.xと [&hellip;]</p>\n","slug":"spring-boot_vertion-up_2-7to3-1","date":"2023/08/05","modified":"2024/06/24","featuredImage":{"node":{"altText":"","gatsbyImage":{"images":{"sources":[{"srcSet":"/_gatsby/image/055f92f416681519f0cb6dfa9caa9f33/9a4825e155d2872d519eab5b88ddb375/Spring_Boot.avif?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2024%2F06%2FSpring_Boot.png&a=w%3D80%26h%3D80%26fm%3Davif%26q%3D75&cd=63ec6209cbaf9da0e95ae1c75d5c6f45 80w,/_gatsby/image/055f92f416681519f0cb6dfa9caa9f33/43792de743fd5bc0d91aacb4cd9248ae/Spring_Boot.avif?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2024%2F06%2FSpring_Boot.png&a=w%3D160%26h%3D160%26fm%3Davif%26q%3D75&cd=63ec6209cbaf9da0e95ae1c75d5c6f45 160w,/_gatsby/image/055f92f416681519f0cb6dfa9caa9f33/dec15694502a7d5b66ff9f59071a2d81/Spring_Boot.avif?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2024%2F06%2FSpring_Boot.png&a=w%3D320%26h%3D320%26fm%3Davif%26q%3D75&cd=63ec6209cbaf9da0e95ae1c75d5c6f45 320w,/_gatsby/image/055f92f416681519f0cb6dfa9caa9f33/eafb8c4913aa0fa6a6e2477d6f608ba5/Spring_Boot.avif?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2024%2F06%2FSpring_Boot.png&a=w%3D640%26h%3D640%26fm%3Davif%26q%3D75&cd=63ec6209cbaf9da0e95ae1c75d5c6f45 640w","type":"image/avif","sizes":"(min-width: 320px) 320px, 100vw"},{"srcSet":"/_gatsby/image/055f92f416681519f0cb6dfa9caa9f33/e1cb8e392ab57f84e8715e8f280139e9/Spring_Boot.webp?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2024%2F06%2FSpring_Boot.png&a=w%3D80%26h%3D80%26fm%3Dwebp%26q%3D75&cd=63ec6209cbaf9da0e95ae1c75d5c6f45 80w,/_gatsby/image/055f92f416681519f0cb6dfa9caa9f33/c422829a9b1207f3db3ab3c82a7de728/Spring_Boot.webp?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2024%2F06%2FSpring_Boot.png&a=w%3D160%26h%3D160%26fm%3Dwebp%26q%3D75&cd=63ec6209cbaf9da0e95ae1c75d5c6f45 160w,/_gatsby/image/055f92f416681519f0cb6dfa9caa9f33/a05606add6dbd1281d5d4145c1de3869/Spring_Boot.webp?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2024%2F06%2FSpring_Boot.png&a=w%3D320%26h%3D320%26fm%3Dwebp%26q%3D75&cd=63ec6209cbaf9da0e95ae1c75d5c6f45 320w,/_gatsby/image/055f92f416681519f0cb6dfa9caa9f33/64a2cb82b919a02e77e9ea4ea4314b21/Spring_Boot.webp?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2024%2F06%2FSpring_Boot.png&a=w%3D640%26h%3D640%26fm%3Dwebp%26q%3D75&cd=63ec6209cbaf9da0e95ae1c75d5c6f45 640w","type":"image/webp","sizes":"(min-width: 320px) 320px, 100vw"}],"fallback":{"src":"/_gatsby/image/055f92f416681519f0cb6dfa9caa9f33/7b298770dfbac979ea07f70a796f8b80/Spring_Boot.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2024%2F06%2FSpring_Boot.png&a=w%3D80%26h%3D80%26fm%3Dpng%26q%3D75&cd=63ec6209cbaf9da0e95ae1c75d5c6f45","srcSet":"/_gatsby/image/055f92f416681519f0cb6dfa9caa9f33/7b298770dfbac979ea07f70a796f8b80/Spring_Boot.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2024%2F06%2FSpring_Boot.png&a=w%3D80%26h%3D80%26fm%3Dpng%26q%3D75&cd=63ec6209cbaf9da0e95ae1c75d5c6f45 80w,/_gatsby/image/055f92f416681519f0cb6dfa9caa9f33/c359e0cc01269d2c63f27c71ca9207bf/Spring_Boot.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2024%2F06%2FSpring_Boot.png&a=w%3D160%26h%3D160%26fm%3Dpng%26q%3D75&cd=63ec6209cbaf9da0e95ae1c75d5c6f45 160w,/_gatsby/image/055f92f416681519f0cb6dfa9caa9f33/e680dcc70730e97e1b463f4c76a3a5d8/Spring_Boot.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2024%2F06%2FSpring_Boot.png&a=w%3D320%26h%3D320%26fm%3Dpng%26q%3D75&cd=63ec6209cbaf9da0e95ae1c75d5c6f45 320w,/_gatsby/image/055f92f416681519f0cb6dfa9caa9f33/cae138517f6c663ed18609bcb5623ef1/Spring_Boot.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2024%2F06%2FSpring_Boot.png&a=w%3D640%26h%3D640%26fm%3Dpng%26q%3D75&cd=63ec6209cbaf9da0e95ae1c75d5c6f45 640w","sizes":"(min-width: 320px) 320px, 100vw"}},"layout":"constrained","width":320,"height":320,"backgroundColor":"rgb(8,8,8)"}}},"categories":{"nodes":[{"name":"技術"}]},"tags":{"nodes":[{"name":"Java"},{"name":"Spring Boot"},{"name":"バージョンアップ"}]}},"wpPrevious":{"title":"Oracle DBのセッションを増やすor強制終了する【ORA-12516対応】","slug":"ora-12516","categories":{"nodes":[{"name":"技術"}]}},"wpNext":null},"pageContext":{"id":"cG9zdDozMDcw","previousPostId":"cG9zdDoyOTg=","nextPostId":null,"imagePath":null}},"staticQueryHashes":["2488138200","3280520893"],"slicesMap":{}}