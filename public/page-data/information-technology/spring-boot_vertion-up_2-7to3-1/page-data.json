{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/information-technology/spring-boot_vertion-up_2-7to3-1","result":{"data":{"blogImage":{"edges":[]},"oldBlogImage":{"edges":[{"node":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAADpElEQVR42m1UXWwUVRSeKgV/QiVqNCbaBF5IygMPG0jV7r0zs1vwiQSlwENBQVJT52+308VqjPOkb/YBHoiEt0Yhi7a7M7OzbdlaJUJiNNE3NARQgvqkMRJNtGWu37kzs2x/bnLn3rk/3/nOud85itLRPM97gMZytf9xy+cnzID7VsB/wXjP9Pk9zG9j/TMr5EcqtX2bsztCKF3KqtaVLRo+P2b67Lbb0sVYS4/tSBUAkt3B3G0VYqwLnLnuhPoQ3THr+a2WP8DbYPQZ+SjXbdXZWXdBF6VZLcYFMGLLAIozwGTOlmmvPKeJsUu6MGr8fSNQHctn7yVwKTPLV89WviiK5MIKkHW7WWdLpaYag8DyaI1pRsAP236xV2JaDX7CXSiIlNHKywAnAxRHue8nrN3PC8Ju8D+MGtsvMUKmOWGeKSMf8yedpnYTbgozIDc5xSemOcWM1svzcG9eF+MwOk5AAf8PRqpO7YXtWdzGZvPP2ZE+rDhN9Q2ylrEz6zwmgDIAwOYu1n4Ey68xtnDmExh6xwy0nVn8h6pDD9LE/X7wUXtOfV0Bi4BeTcYOblGgMf8GIEesiD/rLfKH0Dcoq6SRSqzLq/Zt9PzcI7RWaqiGYgfqb05DlYAJGD/nVYc2diqg3UTKSNyXGbF1555/iuZOwEsIJomWSWZ2Q130PLBBy1xZr2Vgtv9iL4m8/d9QXUW+Hl6Rgu+E7GXa4IsJ6HotyyYremkTvJos1bUd2R68dRU75HcIDJt3S829z3QyWM0qY52CXTDqbIT+q+k6xF5RkFoz44sFksrvzgzf0il2GikE0kCWANFAH17/O5z/oDM0dkt/2mnyd3FAO06ixoElM9B3J251uNyOV7HXDNRTeLS/kRVvZ+5Tyib5zF8D6+PKq2AFYV87+WVROIE6leGUr/Y/bPtsFwRcQYwvpxXnBxQCXeb+t7luTygynqNhYRsMhcb0rifkZTPkw1QUnEhbwqUa2J6HW3cw/gOgX0nQlp/fs1pCEkwaZTesGtitKA6BegZWDjiz6qGTl4uUhj+TJsnYm9N8wA4Hcigg3Irye5C3B9Hfwn5E8bci9XQSgoSxkr3cSLX4WCnSPkzr3Z+48BdJinIahUBIt9Hpf+LKYDzx1aAwZtjkWmWkyqeYUGBRmm64SSGQYLLqhCiwTRTYhUJcTtLzmtHIv5KAia41WdWZamDb4wTsKC59CoY/AfBf6njlW3ioizLPp3b3dAo9a/8DqmBOSbpoLp0AAAAASUVORK5CYII="},"images":{"fallback":{"src":"/static/fd00e5ed66cff0304f5ebb7dbce68dc2/5f035/Spring_Boot.png","srcSet":"/static/fd00e5ed66cff0304f5ebb7dbce68dc2/1f8a1/Spring_Boot.png 80w,\n/static/fd00e5ed66cff0304f5ebb7dbce68dc2/e9a79/Spring_Boot.png 160w,\n/static/fd00e5ed66cff0304f5ebb7dbce68dc2/5f035/Spring_Boot.png 320w,\n/static/fd00e5ed66cff0304f5ebb7dbce68dc2/eadd3/Spring_Boot.png 640w","sizes":"(min-width: 320px) 320px, 100vw"},"sources":[{"srcSet":"/static/fd00e5ed66cff0304f5ebb7dbce68dc2/793cf/Spring_Boot.avif 80w,\n/static/fd00e5ed66cff0304f5ebb7dbce68dc2/6de5b/Spring_Boot.avif 160w,\n/static/fd00e5ed66cff0304f5ebb7dbce68dc2/20389/Spring_Boot.avif 320w,\n/static/fd00e5ed66cff0304f5ebb7dbce68dc2/8c32c/Spring_Boot.avif 640w","type":"image/avif","sizes":"(min-width: 320px) 320px, 100vw"},{"srcSet":"/static/fd00e5ed66cff0304f5ebb7dbce68dc2/61ca6/Spring_Boot.webp 80w,\n/static/fd00e5ed66cff0304f5ebb7dbce68dc2/60b4d/Spring_Boot.webp 160w,\n/static/fd00e5ed66cff0304f5ebb7dbce68dc2/5e011/Spring_Boot.webp 320w,\n/static/fd00e5ed66cff0304f5ebb7dbce68dc2/90d07/Spring_Boot.webp 640w","type":"image/webp","sizes":"(min-width: 320px) 320px, 100vw"}]},"width":320,"height":320}}}}]},"markdownRemark":{"id":"fffc138e-88d9-5ae7-b9fc-fa025af96b56","excerpt":"Spring Bootのバージョンアップに際して、一部ソースコード修正などの対応が必要になる部分が少なからずあります。私がハマったところベースでいくつか対応方法を説明していきたいと思います。 サポート期間が、2.7.xと3.0.xとでほとんど変わらないため、多くは3.1.x…","html":"<p>Spring Bootのバージョンアップに際して、一部ソースコード修正などの対応が必要になる部分が少なからずあります。私がハマったところベースでいくつか対応方法を説明していきたいと思います。</p>\n<p>サポート期間が、2.7.xと3.0.xとでほとんど変わらないため、多くは3.1.xまで一気に上げるかと思われます。メジャーバージョンアップである「2.7.x→3.0.x」が、破壊的変更もあって、対応としてはかなり大変ですが、マイナーバージョンアップである「3.0.x→3.1.x」のほうは影響がないことがほとんどだと思います。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; margin-left: initial;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/16871ba6b6f3db091df6cda5b297732d/abbfe/image-1024x416.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA9UlEQVR42m2Q646EIAyFef933N1s1nVGQRFLW8JFpoqa+TFfiOnB03JAGee+u0479zc8e2MmmDv9+/P4GuxoEWfvP67J+5VIWYD/Uc8AD2MGazlGRlrs4okckyNaEGVJsdd07shcYFbbQa1VvjmlknOT+aIepINdp1QvFBHPs5WKEPu+997HmKTfLU5rbbRps8ZhFKZpMsZsF4pz5hDkXBmMiDHG9oME5tvHzDK3lNIyns2QLQWUrVKyONKVSgbd7l0SrrCKbEHO2GuyyH6/ZMkhhPuSeHBbJQcAlK3UNxTmlQKJR9qkOR0P1mJLkHZUky3I9sYLGo/QuHKdFJoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/16871ba6b6f3db091df6cda5b297732d/85704/image-1024x416.webp 240w,\n/static/16871ba6b6f3db091df6cda5b297732d/2d484/image-1024x416.webp 480w,\n/static/16871ba6b6f3db091df6cda5b297732d/ac99e/image-1024x416.webp 960w,\n/static/16871ba6b6f3db091df6cda5b297732d/d757a/image-1024x416.webp 1024w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/16871ba6b6f3db091df6cda5b297732d/74bfa/image-1024x416.png 240w,\n/static/16871ba6b6f3db091df6cda5b297732d/b3a52/image-1024x416.png 480w,\n/static/16871ba6b6f3db091df6cda5b297732d/97137/image-1024x416.png 960w,\n/static/16871ba6b6f3db091df6cda5b297732d/abbfe/image-1024x416.png 1024w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/16871ba6b6f3db091df6cda5b297732d/97137/image-1024x416.png\"\n            alt=\"image 1024x416\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>大まかな流れは下記の公式の移行ガイド(英語)を読みながら進めていくのが良いかと思います。</p>\n<p><a href=\"https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide\">https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide</a></p>\n<h2>Spring Security 6系への対応</h2>\n<p>SecurityConfigurationの実装の仕方を変える必要があります。WebSecurityConfigurerAdapterを継承して構築していたかと思われますが、これが非推奨となり、SecurityFilterChainを@Beanで定義する実装に修正する必要があります。3.0.x</p>\n<h3>【2.7.xまでのコード例】</h3>\n<pre><code>import org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n\n@Configuration\npublic class SecurityConfiguration extends WebSecurityConfigurerAdapter {\n  @Autowired\n  public void configure(AuthenticationManagerBuilder auth) throws Exception {\n    auth.inMemoryAuthentication();\n  }\n\n  @Override\n  protected void configure(HttpSecurity http) throws Exception {\n    http.authorizeRequests()\n        .antMatchers(\"/health/**\")\n        .permitAll()\n        .anyRequest()\n        .authenticated();\n    http.csrf().disable();\n  }\n}\n</code></pre>\n<h3>【3.0.xでのコード修正例】</h3>\n<pre><code>import org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.provisioning.InMemoryUserDetailsManager;\nimport org.springframework.security.web.SecurityFilterChain;\n\n@Configuration\npublic class SecurityConfiguration {\n  @Bean\n  public InMemoryUserDetailsManager userDetailsService() {\n    return new InMemoryUserDetailsManager();\n  }\n\n  @Bean\n  public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n    http.authorizeHttpRequests()\n        .requestMatchers(\"/health/**\")\n        .permitAll()\n        .anyRequest()\n        .authenticated();\n    http.csrf().disable();\n    return http.build();\n  }\n}\n</code></pre>\n<h3>修正ポイント</h3>\n<ul>\n<li>\n<p>WebSecurityConfigurerAdapter の継承を辞める。</p>\n</li>\n<li>\n<p>configure(HttpSecurity)のOverrideではなく、public SecurityFilterChain securityFilterChain(HttpSecurity)を@Bean定義する。</p>\n<ul>\n<li>その中で、HttpSecurity.authorizeRequests()ではなく、HttpSecurity.authorize<strong>Http</strong>Requests()を使うように変更。（非常に視認性が悪いですが、authorize<strong>Http</strong>Requestsという異なる名称のものがあります。）</li>\n</ul>\n</li>\n<li>\n<p>LDAP認証、JDBC認証、インメモリ認証を使う場合はそれぞれ対応が必要。何れも下記のページを参照して対応するのがわかりやすい。</p>\n</li>\n</ul>\n<p><a href=\"https://spring.io/blog/2022/02/21/spring-security-without-the-websecurityconfigureradapter\">https://spring.io/blog/2022/02/21/spring-security-without-the-websecurityconfigureradapter</a></p>\n<h2>javax → jakarta置換</h2>\n<p>商標権の都合で、java EE系のパッケージが、jakarta EEというパッケージに変わっています。基本的に中身が変わる類のものではないので、ソースコードの置換をしていく対応となります。</p>\n<p>ただし、引き続きjavaxパッケージとして使われるものも多いので、javaxをjakartaに全て一括置換はNGです。コンパイル時にClassNotFoundが発生すると思うので、それらを何度か適宜置換していく対応していってください。「javax.annotation → jakarta.annotation」の置換でそれなりに充足すると思います。</p>\n<h2>httpClientが 4.x -> 5.x に変更</h2>\n<p>SpringBootの内部依存しているhttpClientのメジャーバージョンが変わっており、その変更に対応する必要があります。RestTemplateで使っている人も多い部分かと思います。それなりにガッツリ変わっているので、頑張って移行ガイドを読んでいく必要があります。</p>\n<h3>【2.7.xまでのコード例】</h3>\n<pre><code>  @Bean\n  public RestTemplate restTemplate() throws NoSuchAlgorithmException {\n    HttpClientBuilder httpClientBuilder = HttpClientBuilder.create();\n    httpClientBuilder.setSSLContext(SSLContext.getDefault());\n\n    HttpComponentsClientHttpRequestFactory requestFactory =\n        new HttpComponentsClientHttpRequestFactory();\n    requestFactory.setHttpClient(httpClientBuilder.build());\n    requestFactory.setConnectTimeout(5000);\n    requestFactory.setReadTimeout(5000);\n\n    return new RestTemplate(requestFactory);\n  }\n</code></pre>\n<h3>【3.0.xでのコード修正例】</h3>\n<pre><code>  @Bean\n  public RestTemplate restTemplate() throws NoSuchAlgorithmException {\n\n    try (PoolingHttpClientConnectionManager connectionManager = PoolingHttpClientConnectionManagerBuilder.create()\n        .setSSLSocketFactory(SSLConnectionSocketFactoryBuilder.create()\n            .setSslContext(SSLContext.getDefault())\n            .setTlsVersions(TLS.V_1_3)\n            .build())\n        .setDefaultSocketConfig(SocketConfig.custom()\n            .setSoTimeout(Timeout.ofSeconds(5L))\n            .build())\n        .setPoolConcurrencyPolicy(PoolConcurrencyPolicy.STRICT)\n        .setDefaultConnectionConfig(ConnectionConfig.custom()\n            .setConnectTimeout(Timeout.ofSeconds(5L))\n            .build())\n        .build()) {\n      HttpClientBuilder httpClientBuilder = HttpClientBuilder.create();\n      httpClientBuilder.setConnectionManager(connectionManager);\n      HttpComponentsClientHttpRequestFactory requestFactory =\n          new HttpComponentsClientHttpRequestFactory();\n      requestFactory.setHttpClient(httpClientBuilder.build());\n\n      return new RestTemplate(requestFactory);\n    }\n  }\n</code></pre>\n<h3>修正ポイント</h3>\n<p>ポイントと言えるほど要点があるわけではなく、、下記リンク先の移行ガイド(英語)を参考にがっつり書き換えていく必要があります。ReadTimeoutというのが非推奨となって、SoTimeoutに変えるなど、かなりしっかりと読まないとなりません。</p>\n<p><a href=\"https://hc.apache.org/httpcomponents-client-5.2.x/migration-guide/preparation.html\">https://hc.apache.org/httpcomponents-client-5.2.x/migration-guide/preparation.html</a></p>\n<p><a href=\"https://hc.apache.org/httpcomponents-client-5.2.x/migration-guide/migration-to-classic.html\">https://hc.apache.org/httpcomponents-client-5.2.x/migration-guide/migration-to-classic.html</a></p>\n<h2>hibernate の5.x → 6.xの対応</h2>\n<p>ORMである、hibernateのメジャーバージョンアップがなされています。hibernateを利用している場合は、これに対応する必要がありますが、破壊的変更が非常に多く、おそらく大多数の方が多大な対応を必要とすると思われます。Type systemという根幹がかなり変わっているため、影響が大きいです。変更内容も広範になるため、別記事にまとめようと思います。</p>\n<p>下記がhibernate公式の移行ガイド(英語)です。</p>\n<p><a href=\"https://docs.jboss.org/hibernate/orm/6.0/migration-guide/migration-guide.html\">https://docs.jboss.org/hibernate/orm/6.0/migration-guide/migration-guide.html</a></p>","fields":{"slug":"/posts/spring-boot_vertion-up_2-7to3-1/"},"frontmatter":{"title":"Spring Bootの2.7系から3.1系へのバージョンアップ対応のハマりどころ","date":"2023/08/05","dateModified":null,"description":null,"category":null,"categories":["information-technology"],"tags":["java","spring-boot","バージョンアップ"]}},"mdPrevious":{"fields":{"slug":"/posts/smartphone-rate-plan/"},"frontmatter":{"title":"スマホの新料金プランで3大キャリアを選んではいけない理由","category":null,"categories":["life"]}},"mdNext":{"fields":{"slug":"/posts/switching-java-version/"},"frontmatter":{"title":"Javaのバージョンを動的に変更するバッチを作りました","category":null,"categories":["information-technology"]}}},"pageContext":{"id":"fffc138e-88d9-5ae7-b9fc-fa025af96b56","previousPostId":"e0b353b0-aa24-5076-9c96-c2ae352fa0d8","nextPostId":"8744e3aa-c6b3-59c0-b799-dc30f31f4f5f","imagePath":"posts/spring-boot_vertion-up_2-7to3-1/images/Spring_Boot.png"}},"staticQueryHashes":["3695098706","798193786"],"slicesMap":{}}