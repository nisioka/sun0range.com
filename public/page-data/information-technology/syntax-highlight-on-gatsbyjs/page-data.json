{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/information-technology/syntax-highlight-on-gatsbyjs","result":{"data":{"blogImage":{"edges":[{"node":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/webp;base64,UklGRlgAAABXRUJQVlA4IEwAAABwAwCdASoUAA0APtFUo0uoJKMhsAgBABoJQBdgBER/BH7J3QAA/vEMbZZwLCtwrdrSiHhxDSlcdyAZDUPfjPvrg6g1f6K6jAPfgAAA"},"images":{"fallback":{"src":"/static/eed99fbafaf1f2127b7970dcbbb06623/95a23/cording.webp","srcSet":"/static/eed99fbafaf1f2127b7970dcbbb06623/02f98/cording.webp 120w,\n/static/eed99fbafaf1f2127b7970dcbbb06623/e46a8/cording.webp 240w,\n/static/eed99fbafaf1f2127b7970dcbbb06623/95a23/cording.webp 480w","sizes":"(min-width: 480px) 480px, 100vw"},"sources":[{"srcSet":"/static/eed99fbafaf1f2127b7970dcbbb06623/eb765/cording.avif 120w,\n/static/eed99fbafaf1f2127b7970dcbbb06623/03634/cording.avif 240w,\n/static/eed99fbafaf1f2127b7970dcbbb06623/a2690/cording.avif 480w","type":"image/avif","sizes":"(min-width: 480px) 480px, 100vw"}]},"width":480,"height":320}}}}]},"oldBlogImage":{"edges":[]},"markdownRemark":{"id":"aa1304f9-f375-58e6-87fa-b07d1177b3d8","excerpt":"概要 GatsbyJS での汎用的な構文ハイライト(syntax highlight)の実装方法を紹介します。 本ブログは Markdown ファイルと WordPress の両方のコンテンツを Gatsby…","html":"<h2>概要</h2>\n<p>GatsbyJS での汎用的な構文ハイライト(syntax highlight)の実装方法を紹介します。<br>\n本ブログは Markdown ファイルと WordPress の両方のコンテンツを Gatsby で表示していて、その場合に使えるやり方です。もちろんどちらかのみの場合でも OK です。<br>\n<code>react-syntax-highlighter</code>というプラグインを使って、それに上手くコンテンツデータを渡すということをやってます。</p>\n<p>参考にしたサイトはこちら。<br>\n<a href=\"https://dimitri.codes/adding-syntax-highlighting-wordpress-gatsby/\" target=\"_blank\"><a href=\"https://dimitri.codes/adding-syntax-highlighting-wordpress-gatsby/\">https://dimitri.codes/adding-syntax-highlighting-wordpress-gatsby/</a></a></p>\n<p>また、実コードが見たい方は、実際の変更コミットはこちらを見てください。<br>\n<a href=\"https://github.com/nisioka/sun0range.com/commit/7a469363fc9b309f720cf7903ba1da5ce39f9895\" target=\"_blank\"><a href=\"https://github.com/nisioka/sun0range.com/commit/7a469363fc9b309f720cf7903ba1da5ce39f9895\">https://github.com/nisioka/sun0range.com/commit/7a469363fc9b309f720cf7903ba1da5ce39f9895</a></a></p>\n<h2>前提・準備</h2>\n<p>Gatsby でのコンテンツを表示に、<code>dangerouslySetInnerHtml={{__html=content}}</code> を使用していることを想定していて、それを書き換えていきます。\nまた、TypeScript も使用しているので以降のコードも.ts もしくは.tsx です。</p>\n<p>まずは依存関係のインストールを行ってください。(TypeScript なので、開発のしやすさのために@types も dev に入れてます。)</p>\n<pre><code class=\"language-bash\">npm install --save html-react-parser react-syntax-highlighter\nnpm install --save-dev @types/react-syntax-highlighter\n</code></pre>\n<h2>実装</h2>\n<p>まず、修正前の実装イメージを示します。<strong>post.content</strong>がコンテンツデータで、それを dangerouslySetInnerHTML に渡して表示しているとします。</p>\n<pre><code class=\"language-typescript\">import * as React from \"react\"\n\nconst BlogPostTemplate = () => {\n  // ノイズになるため省略。ここでpostのデータを取得したりしている。\n\n  return (\n    &#x3C;>\n      // ノイズになるため省略。実際は他にもレイアウトしている。\n      &#x3C;section dangerouslySetInnerHTML={{ __html: post.content }} />\n    &#x3C;/>\n  )\n}\n</code></pre>\n<p>修正後のコードが下記です。</p>\n<pre><code class=\"language-typescript\">import * as React from \"react\"\nimport { Link, graphql } from \"gatsby\"\n\nimport parse, { domToReact } from \"html-react-parser\"\nimport SyntaxHighlighter from \"react-syntax-highlighter\"\nimport { androidstudio } from \"react-syntax-highlighter/dist/cjs/styles/hljs\"\n\nconst BlogPostTemplate = () => {\n  // ノイズになるため省略。ここでpostのデータを取得したりしている。\n\n  return (\n    &#x3C;>\n      // ノイズになるため省略。実際は他にもレイアウトしている。\n      &#x3C;section>{parse(post.content, { replace: replaceCode })}&#x3C;/section>\n    &#x3C;/>\n  )\n}\n\nconst replaceCode = (node: any) => {\n  if (!node) return node\n  if (node.name === \"pre\") {\n    const dom = domToReact(getCode(node))\n    let result = \"\"\n    switch (typeof dom) {\n      case \"string\":\n        result = dom as string\n        break\n      case \"object\":\n        if (Array.isArray(dom)) {\n          // React.JSX.Element[]\n          const elmArr = dom as React.JSX.Element[]\n          elmArr.map(elm => {\n            if (elm.props &#x26;&#x26; elm.props.children) {\n              result += elm.props.children as string\n            }\n          })\n        } else {\n          // React.JSX.Element\n          const elm = dom as React.JSX.Element\n          if (elm.props &#x26;&#x26; elm.props.children) {\n            result = elm.props.children as string\n          }\n        }\n        break\n    }\n\n    return (\n      node.children.length > 0 &#x26;&#x26; (\n        &#x3C;SyntaxHighlighter\n          style={androidstudio}\n          language={getLanguage(node)}\n          showLineNumbers={true}\n        >\n          {result}\n        &#x3C;/SyntaxHighlighter>\n      )\n    )\n  }\n}\n\nconst getLanguage = (node: any) => {\n  function getClassInLanguage(className: string) {\n    let result = \"\"\n    className.split(/\\s+/).forEach(s => {\n      if (s.startsWith(\"language-\")) {\n        result = s.replace(\"language-\", \"\")\n        break\n      }\n    })\n    return result\n  }\n\n  if (node.attribs.class &#x26;&#x26; node.attribs.class !== \"wp-block-code\") {\n    return getClassInLanguage(node.attribs.class as string)\n  } else if (node.children[0]?.attribs?.class) {\n    return getClassInLanguage(node.children[0].attribs.class as string)\n  }\n  return \"java\" // default\n}\n\nconst getCode = (node: any) => {\n  if (node.children.length > 0 &#x26;&#x26; node.children[0].name === \"code\") {\n    return node.children[0].children\n  } else {\n    return node.children\n  }\n}\n</code></pre>\n<p>上記コードについて説明します。</p>\n<ol>\n<li>元々<code>dangerouslySetInnerHTML</code>を使っていたものを、<code>html-react-parser</code>ライブラリの<code>parse</code>関数を使うように変更します。</li>\n<li><code>parse</code>関数は HTML を React コンポーネントに変換し、後述する自作の<code>replaceCode</code>関数を使用して<code>&#x3C;code></code>ブロックを検出します。それ以外はそのままです。</li>\n<li><code>replaceCode</code>関数はコードブロックをハイライト表示するための処理を行います。\n<ol>\n<li><code>parse</code>関数が DOM 要素を node として一つづつ渡してくるので、node が「<code>&#x3C;pre></code>タグ内に<code>&#x3C;code></code>の子を持つ要素」<strong>以外</strong>の要素の場合は、置き換えせずそのままです。</li>\n<li>「<code>&#x3C;pre></code>タグ内に<code>&#x3C;code></code>の子を持つ要素」である場合、その中のコードを取得し、<code>react-syntax-highlighter</code>ライブラリの<code>SyntaxHighlighter</code>コンポーネントで整形します。</li>\n<li><code>SyntaxHighlighter</code>コンポーネントでは、言語やスタイルが選べて、\n<ol>\n<li><code>language</code>には<a href=\"https://github.com/react-syntax-highlighter/react-syntax-highlighter/blob/HEAD/AVAILABLE_LANGUAGES_HLJS.MD\" target=\"_blank\">ここ</a>にある言語を指定します。その言語の指定の仕方はメタ情報として付与されている html の class 名を使って自作の<code>getLanguage</code>関数で判定しています。\n<ol>\n<li>Markdown では、<code> ```javascript</code>というようにコードブロックの先頭に指定します。</li>\n<li>WordPress では，「高度な設定」の「追加 CSS クラス」に<code>language-XXX</code>というように XXX に言語を指定します。(※1)</li>\n</ol>\n</li>\n<li><code>style</code>には<a href=\"https://github.com/react-syntax-highlighter/react-syntax-highlighter/blob/HEAD/AVAILABLE_STYLES_HLJS.MD\" target=\"_blank\">ここ</a>にある好きなスタイルを指定します。色々と試して好きな見た目を選んでください。</li>\n</ol>\n</li>\n</ol>\n</li>\n</ol>\n<p>※1: WordPress の「高度な設定」の例。\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 428px; margin-left: initial;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 126.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/webp;base64,UklGRmwAAABXRUJQVlA4IGAAAADwAwCdASoUABkAPtFgqU+oJaOiKAgBABoJaWZAABtpPv5NaNbZIPAAAP7xPjXQ5H1FJFMEGpXXawNXdJQ9UT+vOuw37DYX463ZeYb0Vpc0pOnes6x+/OUyEoRya9IAAAA='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/e5f0aa6338a6db2c83efeef2006a64ee/85704/wordpressExample.webp 240w,\n/static/e5f0aa6338a6db2c83efeef2006a64ee/f403b/wordpressExample.webp 428w\"\n              sizes=\"(max-width: 428px) 100vw, 428px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/e5f0aa6338a6db2c83efeef2006a64ee/85704/wordpressExample.webp 240w,\n/static/e5f0aa6338a6db2c83efeef2006a64ee/f403b/wordpressExample.webp 428w\"\n            sizes=\"(max-width: 428px) 100vw, 428px\"\n            type=\"image/webp\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/e5f0aa6338a6db2c83efeef2006a64ee/f403b/wordpressExample.webp\"\n            alt=\"wordpressExample\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n    </span></p>\n<h2>終わりに</h2>\n<p>以上で、Gatsby アプリケーションを実行し、構文ハイライトされたコードを確認できるはずです。本記事内のコードも構文ハイライトされて見えているはずです。\nこれで、WordPress と Gatsby で構文ハイライトを実装しました。完全な例に興味がある場合は、このブログのソースコードを 以下の GitHub で確認できます。\n<a href=\"https://github.com/nisioka/sun0range.com/blob/master/src/templates/blog-post.tsx\">https://github.com/nisioka/sun0range.com/blob/master/src/templates/blog-post.tsx</a></p>\n<hr>\n<div class=\"booklink-box\" style=\"text-align:left;padding-bottom:20px;font-size:small;zoom: 1;overflow: hidden;\"><div class=\"booklink-image\" style=\"float:left;margin:0 15px 10px 0;\"><a href=\"\" target=\"_blank\" rel=\"nofollow\"><img src=\"https://thumbnail.image.rakuten.co.jp/@0_mall/book/cabinet/9546/9784844379546.jpg?_ex=200x200\" style=\"border: none;\"></a></div><div class=\"booklink-info\" style=\"line-height:120%;zoom: 1;overflow: hidden;\"><div class=\"booklink-name\" style=\"margin-bottom:10px;line-height:120%\"><a href=\"\" target=\"_blank\" rel=\"nofollow\">【POD】React &amp; Gatsby開発入門</a><div class=\"booklink-powered-date\" style=\"font-size:8pt;margin-top:5px;font-family:verdana;line-height:120%\">posted with <a href=\"https://yomereba.com\" rel=\"nofollow\" target=\"_blank\">ヨメレバ</a></div></div><div class=\"booklink-detail\" style=\"margin-bottom:5px;\">竹本 雄貴 インプレスR&amp;D 2021年04月02日頃    </div><div class=\"booklink-link2\" style=\"margin-top:10px;\"><div class=\"shoplinkamazon\" style=\"margin:5px 0\"><a href=\"//af.moshimo.com/af/c/click?a_id=1041250&amp;p_id=170&amp;pc_id=185&amp;pl_id=4062&amp;s_v=b5Rz2P0601xu&amp;url=https%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4844379542\" target=\"_blank\" rel=\"nofollow\">Amazon</a></div><div class=\"shoplinkkindle\" style=\"margin:5px 0\"><a href=\"//af.moshimo.com/af/c/click?a_id=1041250&amp;p_id=170&amp;pc_id=185&amp;pl_id=4062&amp;s_v=b5Rz2P0601xu&amp;url=https%3A%2F%2Fwww.amazon.co.jp%2Fgp%2Fsearch%3Fkeywords%3D%25E3%2580%2590POD%25E3%2580%2591React%2520%2526%2520Gatsby%25E9%2596%258B%25E7%2599%25BA%25E5%2585%25A5%25E9%2596%2580%26__mk_ja_JP%3D%2583J%2583%255E%2583J%2583i%26url%3Dnode%253D2275256051\" target=\"_blank\" rel=\"nofollow\">Kindle</a></div>                               \t   \t   \t  \t  <div class=\"shoplinktoshokan\" style=\"margin:5px 0\"><a href=\"http://calil.jp/book/4844379542\" target=\"_blank\" rel=\"nofollow\">図書館</a></div>\t</div></div><div class=\"booklink-footer\" style=\"clear: left\"></div></div>","fields":{"slug":"/syntax-highlight-on-gatsbyjs/"},"frontmatter":{"title":"MarkdownでもWordPressでも使えるGatsbyJSでの構文ハイライト","date":"2024/06/10","dateModified":"2024/06/10","description":"WordPressは非常に強力なCMSですが、動的サイトであるため、サーバーの保守やセキュリティ対策が必要です。一方、静的サイトジェネレーターであるGatsbyJSを使用すると、高速で安全なサイトを構築できます。本記事では、AWSにデプロイしていたWordPressサイトをGatsbyJSとGitHub Pagesを使用した静的サイトへ移行する手順を紹介します。","category":"技術","categories":null,"tags":["GatsbyJS","React","syntax highlight"]}},"mdPrevious":{"fields":{"slug":"/connect-ssh/"},"frontmatter":{"title":"WindowsからLinuxへのSSH接続","category":"技術","categories":null}},"mdNext":{"fields":{"slug":"/migrate-from-wordpress/"},"frontmatter":{"title":"AWSにデプロイしていたWordPressサイトをGatsbyJSによるGitHub Pagesでの静的サイトへ移行","category":"技術","categories":null}}},"pageContext":{"id":"aa1304f9-f375-58e6-87fa-b07d1177b3d8","previousPostId":"910892ab-ed22-5b6e-a478-eec5466e98d3","nextPostId":"a5dcd15f-94ff-595b-90cf-25b5ecb7a059","imagePath":"featured/cording.webp"}},"staticQueryHashes":["3695098706","798193786"],"slicesMap":{}}