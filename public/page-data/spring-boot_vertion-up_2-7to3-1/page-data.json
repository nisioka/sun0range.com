{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/spring-boot_vertion-up_2-7to3-1/","result":{"data":{"allFile":{"edges":[]},"mdx":null,"mdPrevious":{"fields":{"slug":"/example/"},"frontmatter":{"title":"MDX example"}},"mdNext":null,"wpPost":{"id":"cG9zdDozMDcw","title":"Spring Bootの2.7系→3.1系へのバージョンアップ対応のハマりどころ","content":"\n<p>Spring Bootのバージョンアップに際して、一部ソースコード修正などの対応が必要になる部分が少なからずあります。私がハマったところベースでいくつか対応方法を説明していきたいと思います。</p>\n\n\n\n<p>サポート期間が、2.7.xと3.0.xとでほとんど変わらないため、多くは3.1.xまで一気に上げるかと思われます。メジャーバージョンアップである「2.7.x→3.0.x」が、破壊的変更もあって、対応としてはかなり大変ですが、マイナーバージョンアップである「3.0.x→3.1.x」のほうは影響がないことがほとんどだと思います。</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><div data-gatsby-image-wrapper=\"\" style=\"position:relative;overflow:hidden;display:inline-block;vertical-align:top\" class=\"gatsby-image-wrapper gatsby-image-wrapper-constrained wp-image-3071 inline-gatsby-image-wrapper\"><div style=\"max-width:1024px;display:block\"><img alt=\"\" role=\"presentation\" aria-hidden=\"true\" src=\"data:image/svg+xml;charset=utf-8,%3Csvg%20height=&#x27;416&#x27;%20width=&#x27;1024&#x27;%20xmlns=&#x27;http://www.w3.org/2000/svg&#x27;%20version=&#x27;1.1&#x27;%3E%3C/svg%3E\" style=\"max-width:100%;display:block;position:static\"/></div><div aria-hidden=\"true\" data-placeholder-image=\"\" style=\"height:100%;left:0;position:absolute;top:0;width:100%\"></div><img data-gatsby-image-ssr=\"\" data-wp-inline-image=\"1\" data-main-image=\"\" style=\"height:100%;left:0;position:absolute;top:0;transform:translateZ(0);transition:opacity 250ms linear;width:100%;will-change:opacity;opacity:0\" sizes=\"(min-width: 1024px) 1024px, 100vw\" decoding=\"async\" loading=\"lazy\" data-src=\"/_gatsby/image/786acd3a58da0bb52df7f251c4d47982/f2f6a750d03192d7fe1162df4857f64e/image.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2023%2F08%2Fimage.png&amp;a=w%3D256%26h%3D104%26fm%3Dpng%26q%3D90&amp;cd=2023-08-05T08%3A22%3A12\" data-srcset=\"/_gatsby/image/786acd3a58da0bb52df7f251c4d47982/f2f6a750d03192d7fe1162df4857f64e/image.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2023%2F08%2Fimage.png&amp;a=w%3D256%26h%3D104%26fm%3Dpng%26q%3D90&amp;cd=2023-08-05T08%3A22%3A12 256w,/_gatsby/image/786acd3a58da0bb52df7f251c4d47982/9bbf24d3115f5cac9a098f18ec5c0b15/image.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2023%2F08%2Fimage.png&amp;a=w%3D512%26h%3D208%26fm%3Dpng%26q%3D90&amp;cd=2023-08-05T08%3A22%3A12 512w,/_gatsby/image/786acd3a58da0bb52df7f251c4d47982/06edcc18853da78cd1b283021746e21a/image.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2023%2F08%2Fimage.png&amp;a=w%3D1024%26h%3D416%26fm%3Dpng%26q%3D90&amp;cd=2023-08-05T08%3A22%3A12 1024w\" alt=\"\"/><noscript><img data-gatsby-image-ssr=\"\" data-wp-inline-image=\"1\" data-main-image=\"\" style=\"height:100%;left:0;position:absolute;top:0;transform:translateZ(0);transition:opacity 250ms linear;width:100%;will-change:opacity;opacity:0\" sizes=\"(min-width: 1024px) 1024px, 100vw\" decoding=\"async\" loading=\"lazy\" src=\"/_gatsby/image/786acd3a58da0bb52df7f251c4d47982/f2f6a750d03192d7fe1162df4857f64e/image.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2023%2F08%2Fimage.png&amp;a=w%3D256%26h%3D104%26fm%3Dpng%26q%3D90&amp;cd=2023-08-05T08%3A22%3A12\" srcSet=\"/_gatsby/image/786acd3a58da0bb52df7f251c4d47982/f2f6a750d03192d7fe1162df4857f64e/image.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2023%2F08%2Fimage.png&amp;a=w%3D256%26h%3D104%26fm%3Dpng%26q%3D90&amp;cd=2023-08-05T08%3A22%3A12 256w,/_gatsby/image/786acd3a58da0bb52df7f251c4d47982/9bbf24d3115f5cac9a098f18ec5c0b15/image.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2023%2F08%2Fimage.png&amp;a=w%3D512%26h%3D208%26fm%3Dpng%26q%3D90&amp;cd=2023-08-05T08%3A22%3A12 512w,/_gatsby/image/786acd3a58da0bb52df7f251c4d47982/06edcc18853da78cd1b283021746e21a/image.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2023%2F08%2Fimage.png&amp;a=w%3D1024%26h%3D416%26fm%3Dpng%26q%3D90&amp;cd=2023-08-05T08%3A22%3A12 1024w\" alt=\"\"/></noscript><script type=\"module\">const t=\"undefined\"!=typeof HTMLImageElement&&\"loading\"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll(\"img[data-main-image]\");for(let e of t){e.dataset.src&&(e.setAttribute(\"src\",e.dataset.src),e.removeAttribute(\"data-src\")),e.dataset.srcset&&(e.setAttribute(\"srcset\",e.dataset.srcset),e.removeAttribute(\"data-srcset\"));const t=e.parentNode.querySelectorAll(\"source[data-srcset]\");for(let e of t)e.setAttribute(\"srcset\",e.dataset.srcset),e.removeAttribute(\"data-srcset\");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector(\"[data-placeholder-image]\").style.opacity=0)}}</script></div><script type=\"application/json\" data-wp-inline-image-hydration=\"1\">{\"image\":{\"images\":{\"sources\":[],\"fallback\":{\"src\":\"/_gatsby/image/786acd3a58da0bb52df7f251c4d47982/f2f6a750d03192d7fe1162df4857f64e/image.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2023%2F08%2Fimage.png&a=w%3D256%26h%3D104%26fm%3Dpng%26q%3D90&cd=2023-08-05T08%3A22%3A12\",\"srcSet\":\"/_gatsby/image/786acd3a58da0bb52df7f251c4d47982/f2f6a750d03192d7fe1162df4857f64e/image.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2023%2F08%2Fimage.png&a=w%3D256%26h%3D104%26fm%3Dpng%26q%3D90&cd=2023-08-05T08%3A22%3A12 256w,/_gatsby/image/786acd3a58da0bb52df7f251c4d47982/9bbf24d3115f5cac9a098f18ec5c0b15/image.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2023%2F08%2Fimage.png&a=w%3D512%26h%3D208%26fm%3Dpng%26q%3D90&cd=2023-08-05T08%3A22%3A12 512w,/_gatsby/image/786acd3a58da0bb52df7f251c4d47982/06edcc18853da78cd1b283021746e21a/image.png?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2023%2F08%2Fimage.png&a=w%3D1024%26h%3D416%26fm%3Dpng%26q%3D90&cd=2023-08-05T08%3A22%3A12 1024w\",\"sizes\":\"(min-width: 1024px) 1024px, 100vw\"}},\"layout\":\"constrained\",\"width\":1024,\"height\":416},\"alt\":\"\",\"className\":\"wp-image-3071 inline-gatsby-image-wrapper\",\"data-wp-inline-image\":\"1\"}</script></figure>\n\n\n\n<p>大まかな流れは下記の公式の移行ガイド(英語)を読みながら進めていくのが良いかと思います。</p>\n\n\n\n<figure class=\"wp-block-embed\"><div class=\"wp-block-embed__wrapper\">\nhttps://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide\n</div></figure>\n\n\n\n<h2 class=\"wp-block-heading\">Spring Security 6系への対応</h2>\n\n\n\n<p>SecurityConfigurationの実装の仕方を変える必要があります。WebSecurityConfigurerAdapterを継承して構築していたかと思われますが、これが非推奨となり、SecurityFilterChainを@Beanで定義する実装に修正する必要があります。3.0.x</p>\n\n\n\n<h3 class=\"wp-block-heading\">【2.7.xまでのコード例】</h3>\n\n\n\n<pre class=\"wp-block-code\"><code>import org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n\n@Configuration\npublic class SecurityConfiguration extends WebSecurityConfigurerAdapter {\n  @Autowired\n  public void configure(AuthenticationManagerBuilder auth) throws Exception {\n    auth.inMemoryAuthentication();\n  }\n\n  @Override\n  protected void configure(HttpSecurity http) throws Exception {\r\n    http.authorizeRequests()\r\n        .antMatchers(\"/health/**\")\r\n        .permitAll()\r\n        .anyRequest()\r\n        .authenticated();\n    http.csrf().disable();\n  }\n}</code></pre>\n\n\n\n<h3 class=\"wp-block-heading\">【3.0.xでのコード修正例】</h3>\n\n\n\n<pre class=\"wp-block-code\"><code>import org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.provisioning.InMemoryUserDetailsManager;\nimport org.springframework.security.web.SecurityFilterChain;\n\n@Configuration\npublic class SecurityConfiguration {\n  @Bean\n  public InMemoryUserDetailsManager userDetailsService() {\n    return new InMemoryUserDetailsManager();\n  }\n\n  @Bean\n  public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n    http.authorizeHttpRequests()\n        .requestMatchers(\"/health/**\")\n        .permitAll()\n        .anyRequest()\n        .authenticated();\n    http.csrf().disable();\n    return http.build();\n  }\n}</code></pre>\n\n\n\n<h3 class=\"wp-block-heading\">修正ポイント</h3>\n\n\n\n<ul>\n<li>WebSecurityConfigurerAdapter の継承を辞める。</li>\n\n\n\n<li>configure(HttpSecurity)のOverrideではなく、public SecurityFilterChain securityFilterChain(HttpSecurity)を@Bean定義する。\n<ul>\n<li>その中で、HttpSecurity.authorizeRequests()ではなく、HttpSecurity.authorize<strong>Http</strong>Requests()を使うように変更。（非常に視認性が悪いですが、authorize<strong>Http</strong>Requestsという異なる名称のものがあります。）</li>\n</ul>\n</li>\n\n\n\n<li>LDAP認証、JDBC認証、インメモリ認証を使う場合はそれぞれ対応が必要。何れも下記のページを参照して対応するのがわかりやすい。</li>\n</ul>\n\n\n\n<figure class=\"wp-block-embed\"><div class=\"wp-block-embed__wrapper\">\nhttps://spring.io/blog/2022/02/21/spring-security-without-the-websecurityconfigureradapter\n</div></figure>\n\n\n\n<h2 class=\"wp-block-heading\">javax → jakarta置換</h2>\n\n\n\n<p>商標権の都合で、java EE系のパッケージが、jakarta EEというパッケージに変わっています。基本的に中身が変わる類のものではないので、ソースコードの置換をしていく対応となります。</p>\n\n\n\n<p>ただし、引き続きjavaxパッケージとして使われるものも多いので、javaxをjakartaに全て一括置換はNGです。コンパイル時にClassNotFoundが発生すると思うので、それらを何度か適宜置換していく対応していってください。「javax.annotation → jakarta.annotation」の置換でそれなりに充足すると思います。</p>\n\n\n\n<h2 class=\"wp-block-heading\">httpClientが 4.x -> 5.x に変更</h2>\n\n\n\n<p>SpringBootの内部依存しているhttpClientのメジャーバージョンが変わっており、その変更に対応する必要があります。RestTemplateで使っている人も多い部分かと思います。それなりにガッツリ変わっているので、頑張って移行ガイドを読んでいく必要があります。</p>\n\n\n\n<h3 class=\"wp-block-heading\">【2.7.xまでのコード例】</h3>\n\n\n\n<pre class=\"wp-block-code\"><code>  @Bean\r\n  public RestTemplate restTemplate() throws NoSuchAlgorithmException {\r\n    HttpClientBuilder httpClientBuilder = HttpClientBuilder.create();\r\n    httpClientBuilder.setSSLContext(SSLContext.getDefault());\r\n\r\n    HttpComponentsClientHttpRequestFactory requestFactory =\r\n        new HttpComponentsClientHttpRequestFactory();\r\n    requestFactory.setHttpClient(httpClientBuilder.build());\r\n    requestFactory.setConnectTimeout(5000);\r\n    requestFactory.setReadTimeout(5000);\r\n\r\n    return new RestTemplate(requestFactory);\r\n  }</code></pre>\n\n\n\n<h3 class=\"wp-block-heading\">【3.0.xでのコード修正例】</h3>\n\n\n\n<pre class=\"wp-block-code\"><code>  @Bean\r\n  public RestTemplate restTemplate() throws NoSuchAlgorithmException {\r\n\r\n    try (PoolingHttpClientConnectionManager connectionManager = PoolingHttpClientConnectionManagerBuilder.create()\r\n        .setSSLSocketFactory(SSLConnectionSocketFactoryBuilder.create()\r\n            .setSslContext(SSLContext.getDefault())\r\n            .setTlsVersions(TLS.V_1_3)\r\n            .build())\r\n        .setDefaultSocketConfig(SocketConfig.custom()\r\n            .setSoTimeout(Timeout.ofSeconds(5L))\r\n            .build())\r\n        .setPoolConcurrencyPolicy(PoolConcurrencyPolicy.STRICT)\r\n        .setDefaultConnectionConfig(ConnectionConfig.custom()\r\n            .setConnectTimeout(Timeout.ofSeconds(5L))\r\n            .build())\r\n        .build()) {\r\n      HttpClientBuilder httpClientBuilder = HttpClientBuilder.create();\r\n      httpClientBuilder.setConnectionManager(connectionManager);\r\n      HttpComponentsClientHttpRequestFactory requestFactory =\r\n          new HttpComponentsClientHttpRequestFactory();\r\n      requestFactory.setHttpClient(httpClientBuilder.build());\r\n\r\n      return new RestTemplate(requestFactory);\r\n    }\r\n  }</code></pre>\n\n\n\n<h3 class=\"wp-block-heading\">修正ポイント</h3>\n\n\n\n<p>ポイントと言えるほど要点があるわけではなく、、下記リンク先の移行ガイド(英語)を参考にがっつり書き換えていく必要があります。ReadTimeoutというのが非推奨となって、SoTimeoutに変えるなど、かなりしっかりと読まないとなりません。</p>\n\n\n\n<figure class=\"wp-block-embed\"><div class=\"wp-block-embed__wrapper\">\nhttps://hc.apache.org/httpcomponents-client-5.2.x/migration-guide/preparation.html\n</div></figure>\n\n\n\n<figure class=\"wp-block-embed\"><div class=\"wp-block-embed__wrapper\">\nhttps://hc.apache.org/httpcomponents-client-5.2.x/migration-guide/migration-to-classic.html\n</div></figure>\n\n\n\n<h2 class=\"wp-block-heading\">hibernate の5.x → 6.xの対応</h2>\n\n\n\n<p>ORMである、hibernateのメジャーバージョンアップがなされています。hibernateを利用している場合は、これに対応する必要がありますが、破壊的変更が非常に多く、おそらく大多数の方が多大な対応を必要とすると思われます。Type systemという根幹がかなり変わっているため、影響が大きいです。変更内容も広範になるため、別記事にまとめようと思います。</p>\n\n\n\n<p>下記がhibernate公式の移行ガイド(英語)です。</p>\n\n\n\n<figure class=\"wp-block-embed\"><div class=\"wp-block-embed__wrapper\">\nhttps://docs.jboss.org/hibernate/orm/6.0/migration-guide/migration-guide.html\n</div></figure>\n","excerpt":"<p>Spring Bootのバージョンアップに際して、一部ソースコード修正などの対応が必要になる部分が少なからずあります。私がハマったところベースでいくつか対応方法を説明していきたいと思います。 サポート期間が、2.7.xと [&hellip;]</p>\n","slug":"spring-boot_vertion-up_2-7to3-1","date":"2023/08/05","featuredImage":null,"categories":{"nodes":[{"name":"技術"}]},"tags":{"nodes":[{"name":"Java"},{"name":"Spring Boot"},{"name":"バージョンアップ"}]}},"wpPrevious":null,"wpNext":{"title":"【オンライン】 JJUG CCC 2022 Spring 発表資料・動画まとめ","slug":"jjug-ccc-2022-spring"}},"pageContext":{"id":"cG9zdDozMDcw","previousPostId":"9bfd140d-9d03-5a4b-a087-60c328cba832","nextPostId":"cG9zdDozMDIy","imagePath":null}},"staticQueryHashes":["3592160066","774471096"],"slicesMap":{}}